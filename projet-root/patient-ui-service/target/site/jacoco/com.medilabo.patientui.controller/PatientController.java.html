<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="fr"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>PatientController.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">patient-ui-service</a> &gt; <a href="index.source.html" class="el_package">com.medilabo.patientui.controller</a> &gt; <span class="el_source">PatientController.java</span></div><h1>PatientController.java</h1><pre class="source lang-java linenums">package com.medilabo.patientui.controller;

import com.medilabo.patientui.dto.RiskAssessmentResponse;
import com.medilabo.patientui.model.Patient;
import com.medilabo.patientui.service.NoteService;
import com.medilabo.patientui.service.PatientService;
import com.itextpdf.text.Document;
import com.itextpdf.text.DocumentException;
import com.itextpdf.text.Paragraph;
import com.itextpdf.text.pdf.PdfWriter;
import jakarta.servlet.http.HttpServletResponse;
import org.springframework.security.access.prepost.PreAuthorize;
import org.springframework.stereotype.Controller;
import org.springframework.ui.Model;
import org.springframework.web.bind.annotation.*;
import org.springframework.web.client.RestTemplate;

import java.io.IOException;
import java.util.HashMap;
import java.util.List;
import java.util.Map;

/**
 * Application: com.medilabo.patientui.controller
 * &lt;p&gt;
 * Classe &lt;strong&gt;PatientController&lt;/strong&gt;.
 * &lt;br/&gt;
 * Rôle : Gère les vues Thymeleaf de l’UI patient (liste, création, édition, notes, rapport PDF).
 * &lt;/p&gt;
 * &lt;p&gt;
 * Sécurité &amp; CSRF :
 * &lt;ul&gt;
 *   &lt;li&gt;Consultations en &lt;b&gt;GET&lt;/b&gt; (liste, formulaires, notes, rapports) : aucun effet de bord.&lt;/li&gt;
 *   &lt;li&gt;Actions d’écriture en &lt;b&gt;POST&lt;/b&gt; (création, mise à jour, suppression, ajout de note) :
 *       protégées par &lt;b&gt;CSRF&lt;/b&gt; via les formulaires.&lt;/li&gt;
 *   &lt;li&gt;La suppression est exposée en &lt;b&gt;POST&lt;/b&gt; pour respecter la sémantique HTTP et bénéficier de la protection CSRF.&lt;/li&gt;
 * &lt;/ul&gt;
 * &lt;/p&gt;
 */
@Controller
public class PatientController {

    private final PatientService patientService;
    private final NoteService noteService;
    private final RestTemplate restTemplate;

    /** URL de base vers le gateway-service (appel des autres microservices via Gateway). */
    private static final String GATEWAY_BASE_URL = &quot;http://gateway-service:8080&quot;;

    /**
     * Injection des dépendances.
     *
     * @param patientService service de gestion des patients (UI ↔ backend patient-service)
     * @param noteService    service d’accès aux notes (UI ↔ note-service)
     * @param restTemplate   client HTTP pour interroger le risk-service via la Gateway
     */
<span class="fc" id="L57">    public PatientController(PatientService patientService, NoteService noteService, RestTemplate restTemplate) {</span>
<span class="fc" id="L58">        this.patientService = patientService;</span>
<span class="fc" id="L59">        this.noteService = noteService;</span>
<span class="fc" id="L60">        this.restTemplate = restTemplate;</span>
<span class="fc" id="L61">    }</span>

    /**
     * Affiche la liste des patients, enrichie de leurs notes et de leur niveau de risque.
     *
     * @param model modèle Thymeleaf
     * @return vue {@code patients}
     */
    @GetMapping(&quot;/patients&quot;)
    @PreAuthorize(&quot;hasAnyRole('ORGANISATEUR', 'PRATICIEN')&quot;)
    public String getAllPatients(Model model) {
<span class="fc" id="L72">        List&lt;Patient&gt; patients = patientService.findAll();</span>
<span class="fc" id="L73">        Map&lt;Long, List&lt;Map&lt;String, Object&gt;&gt;&gt; notesByPatient = new HashMap&lt;&gt;();</span>
<span class="fc" id="L74">        Map&lt;Long, String&gt; riskByPatient = new HashMap&lt;&gt;();</span>

<span class="fc bfc" id="L76" title="All 2 branches covered.">        for (Patient p : patients) {</span>
<span class="fc" id="L77">            notesByPatient.put(p.getId(), noteService.getNotesByPatientId(p.getId()));</span>
            try {
<span class="fc" id="L79">                RiskAssessmentResponse risk = restTemplate.getForObject(</span>
<span class="fc" id="L80">                        GATEWAY_BASE_URL + &quot;/risk/&quot; + p.getId(),</span>
                        RiskAssessmentResponse.class
                );
<span class="pc bpc" id="L83" title="1 of 2 branches missed.">                riskByPatient.put(p.getId(), risk != null ? risk.getRiskLevel() : &quot;Non disponible&quot;);</span>
<span class="nc" id="L84">            } catch (Exception e) {</span>
<span class="nc" id="L85">                riskByPatient.put(p.getId(), &quot;Non disponible&quot;);</span>
<span class="fc" id="L86">            }</span>
<span class="fc" id="L87">        }</span>

<span class="fc" id="L89">        model.addAttribute(&quot;patients&quot;, patients);</span>
<span class="fc" id="L90">        model.addAttribute(&quot;notesByPatient&quot;, notesByPatient);</span>
<span class="fc" id="L91">        model.addAttribute(&quot;riskByPatient&quot;, riskByPatient);</span>
<span class="fc" id="L92">        return &quot;patients&quot;;</span>
    }

    /**
     * Affiche le formulaire d’ajout d’un patient.
     *
     * @param model modèle Thymeleaf
     * @return vue {@code add-patient}
     */
    @GetMapping(&quot;/patients/new&quot;)
    @PreAuthorize(&quot;hasRole('ORGANISATEUR')&quot;)
    public String showAddPatientForm(Model model) {
<span class="fc" id="L104">        model.addAttribute(&quot;patient&quot;, new Patient());</span>
<span class="fc" id="L105">        return &quot;add-patient&quot;;</span>
    }

    /**
     * Crée un nouveau patient (POST protégé par CSRF).
     *
     * @param patient patient à créer
     * @return redirection vers {@code /patients}
     */
    @PostMapping(&quot;/patients&quot;)
    @PreAuthorize(&quot;hasRole('ORGANISATEUR')&quot;)
    public String createPatient(@ModelAttribute Patient patient) {
<span class="fc" id="L117">        patientService.save(patient);</span>
<span class="fc" id="L118">        return &quot;redirect:/patients&quot;;</span>
    }

    /**
     * Ajoute une note pour un patient (POST protégé par CSRF).
     *
     * @param patientId identifiant du patient
     * @param contenu   contenu de la note
     * @return redirection vers {@code /patients}
     */
    @PostMapping(&quot;/notes&quot;)
    @PreAuthorize(&quot;hasRole('PRATICIEN')&quot;)
    public String ajouterNote(@RequestParam(&quot;patientId&quot;) Long patientId,
                              @RequestParam(&quot;contenu&quot;) String contenu) {
<span class="fc" id="L132">        noteService.ajouterNote(patientId, contenu);</span>
<span class="fc" id="L133">        return &quot;redirect:/patients&quot;;</span>
    }

    /**
     * Affiche le formulaire d’édition d’un patient.
     *
     * @param id    identifiant du patient
     * @param model modèle Thymeleaf
     * @return vue {@code edit-patient} ou redirection vers {@code /patients} si non trouvé
     */
    @GetMapping(&quot;/patients/edit/{id}&quot;)
    @PreAuthorize(&quot;hasRole('ORGANISATEUR')&quot;)
    public String showEditForm(@PathVariable Long id, Model model) {
        try {
<span class="fc" id="L147">            Patient patient = patientService.findById(id)</span>
<span class="pc" id="L148">                    .orElseThrow(() -&gt; new IllegalArgumentException(&quot;Patient non trouvé : &quot; + id));</span>
<span class="fc" id="L149">            model.addAttribute(&quot;patient&quot;, patient);</span>
<span class="fc" id="L150">            return &quot;edit-patient&quot;;</span>
<span class="nc" id="L151">        } catch (IllegalArgumentException e) {</span>
<span class="nc" id="L152">            return &quot;redirect:/patients&quot;;</span>
        }
    }

    /**
     * Met à jour les informations d’un patient (POST protégé par CSRF).
     *
     * @param patient patient mis à jour (l’ID doit être renseigné)
     * @return redirection vers {@code /patients}
     */
    @PostMapping(&quot;/patients/update&quot;)
    @PreAuthorize(&quot;hasRole('ORGANISATEUR')&quot;)
    public String updatePatient(@ModelAttribute Patient patient) {
<span class="fc" id="L165">        patientService.save(patient);</span>
<span class="fc" id="L166">        return &quot;redirect:/patients&quot;;</span>
    }

    /**
     * Affiche l’historique des notes d’un patient.
     *
     * @param id    identifiant du patient
     * @param model modèle Thymeleaf
     * @return vue {@code patient-notes}
     */
    @GetMapping(&quot;/patients/{id}/notes&quot;)
    @PreAuthorize(&quot;hasRole('PRATICIEN')&quot;)
    public String showPatientNotes(@PathVariable Long id, Model model) {
<span class="fc" id="L179">        Patient patient = patientService.findById(id)</span>
<span class="pc" id="L180">                .orElseThrow(() -&gt; new IllegalArgumentException(&quot;Patient non trouvé : &quot; + id));</span>
<span class="fc" id="L181">        List&lt;Map&lt;String, Object&gt;&gt; notes = noteService.getNotesByPatientId(id);</span>
<span class="fc" id="L182">        model.addAttribute(&quot;patient&quot;, patient);</span>
<span class="fc" id="L183">        model.addAttribute(&quot;notes&quot;, notes);</span>
<span class="fc" id="L184">        return &quot;patient-notes&quot;;</span>
    }

    /**
     * Affiche le rapport de risque d’un patient.
     *
     * @param id    identifiant du patient
     * @param model modèle Thymeleaf
     * @return vue {@code risk-report}
     */
    @GetMapping(&quot;/patients/{id}/risk&quot;)
    @PreAuthorize(&quot;hasRole('PRATICIEN')&quot;)
    public String showRiskReport(@PathVariable Long id, Model model) {
<span class="fc" id="L197">        Patient patient = patientService.findById(id)</span>
<span class="pc" id="L198">                .orElseThrow(() -&gt; new IllegalArgumentException(&quot;Patient non trouvé : &quot; + id));</span>
<span class="fc" id="L199">        RiskAssessmentResponse risk = restTemplate.getForObject(</span>
                GATEWAY_BASE_URL + &quot;/risk/&quot; + id,
                RiskAssessmentResponse.class
        );
<span class="fc" id="L203">        model.addAttribute(&quot;patient&quot;, patient);</span>
<span class="fc" id="L204">        model.addAttribute(&quot;risk&quot;, risk);</span>
<span class="fc" id="L205">        return &quot;risk-report&quot;;</span>
    }

    /**
     * Supprime un patient (POST protégé par CSRF).
     *
     * @param id identifiant du patient à supprimer
     * @return redirection vers {@code /patients}
     */
    @PostMapping(&quot;/patients/delete/{id}&quot;)
    @PreAuthorize(&quot;hasRole('ORGANISATEUR')&quot;)
    public String deletePatient(@PathVariable Long id) {
<span class="fc" id="L217">        patientService.deleteById(id);</span>
<span class="fc" id="L218">        return &quot;redirect:/patients&quot;;</span>
    }

    /**
     * Génère et télécharge le rapport PDF du risque d’un patient.
     *
     * @param id       identifiant du patient
     * @param response réponse HTTP (flux sortant du PDF)
     * @throws IOException       en cas d’erreur d’écriture de la réponse
     * @throws DocumentException en cas d’erreur iText lors de la génération du PDF
     */
    @GetMapping(&quot;/patients/{id}/report/pdf&quot;)
    @PreAuthorize(&quot;hasRole('PRATICIEN')&quot;)
    public void downloadPdfReport(@PathVariable Long id, HttpServletResponse response)
            throws IOException, DocumentException {
<span class="fc" id="L233">        Patient patient = patientService.findById(id)</span>
<span class="pc" id="L234">                .orElseThrow(() -&gt; new IllegalArgumentException(&quot;Patient non trouvé : &quot; + id));</span>
<span class="fc" id="L235">        RiskAssessmentResponse risk = restTemplate.getForObject(</span>
                GATEWAY_BASE_URL + &quot;/risk/&quot; + id,
                RiskAssessmentResponse.class
        );

<span class="fc" id="L240">        response.setContentType(&quot;application/pdf&quot;);</span>
<span class="fc" id="L241">        response.setHeader(&quot;Content-Disposition&quot;, &quot;attachment; filename=rapport_patient_&quot; + id + &quot;.pdf&quot;);</span>

<span class="fc" id="L243">        Document document = new Document();</span>
<span class="fc" id="L244">        PdfWriter.getInstance(document, response.getOutputStream());</span>
<span class="fc" id="L245">        document.open();</span>
<span class="fc" id="L246">        document.add(new Paragraph(&quot;Rapport de risque de diabète&quot;));</span>
<span class="fc" id="L247">        document.add(new Paragraph(&quot; &quot;));</span>
<span class="fc" id="L248">        document.add(new Paragraph(&quot;Nom : &quot; + patient.getNom()));</span>
<span class="fc" id="L249">        document.add(new Paragraph(&quot;Prénom : &quot; + patient.getPrenom()));</span>
<span class="fc" id="L250">        document.add(new Paragraph(&quot;Date de naissance : &quot; + patient.getDateNaissance()));</span>
<span class="fc" id="L251">        document.add(new Paragraph(&quot;Genre : &quot; + patient.getGenre()));</span>
<span class="pc bpc" id="L252" title="1 of 2 branches missed.">        if (risk != null) {</span>
<span class="fc" id="L253">            document.add(new Paragraph(&quot;Âge : &quot; + risk.getAge()));</span>
<span class="fc" id="L254">            document.add(new Paragraph(&quot;Risque détecté : &quot; + risk.getRiskLevel()));</span>
        } else {
<span class="nc" id="L256">            document.add(new Paragraph(&quot;Risque détecté : Non disponible&quot;));</span>
        }
<span class="fc" id="L258">        document.close();</span>
<span class="fc" id="L259">    }</span>
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.12.202403310830</span></div></body></html>