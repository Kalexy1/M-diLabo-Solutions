<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="fr"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>SecurityConfig.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">auth-service</a> &gt; <a href="index.source.html" class="el_package">com.medilabo.auth.config</a> &gt; <span class="el_source">SecurityConfig.java</span></div><h1>SecurityConfig.java</h1><pre class="source lang-java linenums">package com.medilabo.auth.config;

import com.medilabo.auth.security.JwtIssuer;
import jakarta.servlet.http.Cookie;
import org.springframework.context.annotation.Bean;
import org.springframework.context.annotation.Configuration;
import org.springframework.security.config.annotation.method.configuration.EnableMethodSecurity;
import org.springframework.security.config.annotation.web.builders.HttpSecurity;
import org.springframework.security.config.annotation.web.configuration.EnableWebSecurity;
import org.springframework.security.crypto.bcrypt.BCryptPasswordEncoder;
import org.springframework.security.crypto.password.PasswordEncoder;
import org.springframework.security.web.SecurityFilterChain;
import org.springframework.security.web.csrf.CookieCsrfTokenRepository;

/**
 * Application: com.medilabo.auth.config
 * &lt;p&gt;
 * Classe &lt;strong&gt;SecurityConfig&lt;/strong&gt;.
 * &lt;br/&gt;
 * Rôle : Configure la sécurité pour le microservice &lt;em&gt;auth-service&lt;/em&gt;.
 * &lt;/p&gt;
 *
 * &lt;h3&gt;Fonctionnalités principales :&lt;/h3&gt;
 * &lt;ul&gt;
 *   &lt;li&gt;Active la protection CSRF avec stockage du token dans un cookie
 *       (lisible côté client pour l’intégration avec Thymeleaf).&lt;/li&gt;
 *   &lt;li&gt;Autorise l’accès public aux routes :
 *       &lt;ul&gt;
 *         &lt;li&gt;&lt;code&gt;/auth/register&lt;/code&gt; → inscription&lt;/li&gt;
 *         &lt;li&gt;&lt;code&gt;/auth/login&lt;/code&gt; → formulaire de login&lt;/li&gt;
 *         &lt;li&gt;&lt;code&gt;/access-denied&lt;/code&gt; → page d’accès refusé&lt;/li&gt;
 *         &lt;li&gt;&lt;code&gt;/logout&lt;/code&gt; → déconnexion&lt;/li&gt;
 *         &lt;li&gt;ressources statiques (&lt;code&gt;/css/**&lt;/code&gt;, &lt;code&gt;/js/**&lt;/code&gt;, &lt;code&gt;/images/**&lt;/code&gt;)&lt;/li&gt;
 *         &lt;li&gt;Actuator (&lt;code&gt;/actuator/**&lt;/code&gt;)&lt;/li&gt;
 *       &lt;/ul&gt;
 *   &lt;/li&gt;
 *   &lt;li&gt;Exige une authentification pour toutes les autres requêtes.&lt;/li&gt;
 *   &lt;li&gt;Configure un formulaire de login personnalisé sur &lt;code&gt;/auth/login&lt;/code&gt;.&lt;/li&gt;
 *   &lt;li&gt;À la connexion réussie :
 *     &lt;ul&gt;
 *       &lt;li&gt;Un JWT est généré via {@link JwtIssuer}.&lt;/li&gt;
 *       &lt;li&gt;Le JWT est stocké dans un cookie HttpOnly nommé &lt;code&gt;ACCESS_TOKEN&lt;/code&gt; valable 1h.&lt;/li&gt;
 *       &lt;li&gt;L’utilisateur est redirigé vers &lt;code&gt;/patients&lt;/code&gt; (via le Gateway).&lt;/li&gt;
 *     &lt;/ul&gt;
 *   &lt;/li&gt;
 *   &lt;li&gt;En cas d’échec → redirection vers &lt;code&gt;/auth/login?error&lt;/code&gt;.&lt;/li&gt;
 *   &lt;li&gt;À la déconnexion :
 *     &lt;ul&gt;
 *       &lt;li&gt;Le cookie &lt;code&gt;ACCESS_TOKEN&lt;/code&gt; est supprimé.&lt;/li&gt;
 *       &lt;li&gt;Redirection vers &lt;code&gt;/auth/login?logout&lt;/code&gt;.&lt;/li&gt;
 *     &lt;/ul&gt;
 *   &lt;/li&gt;
 *   &lt;li&gt;Page d’accès refusé définie sur &lt;code&gt;/access-denied&lt;/code&gt;.&lt;/li&gt;
 * &lt;/ul&gt;
 */
@Configuration
@EnableWebSecurity
@EnableMethodSecurity
public class SecurityConfig {

    /** Service responsable de la génération des JWT. */
    private final JwtIssuer jwtIssuer;

    /**
     * Constructeur avec injection de dépendance.
     *
     * @param jwtIssuer service permettant de créer des JWT signés
     */
<span class="fc" id="L69">    public SecurityConfig(JwtIssuer jwtIssuer) {</span>
<span class="fc" id="L70">        this.jwtIssuer = jwtIssuer;</span>
<span class="fc" id="L71">    }</span>

    /**
     * Définit la chaîne de filtres Spring Security pour l’application.
     *
     * &lt;p&gt;Points clés :&lt;/p&gt;
     * &lt;ul&gt;
     *   &lt;li&gt;CSRF activé avec {@link CookieCsrfTokenRepository} (token envoyé dans un cookie).&lt;/li&gt;
     *   &lt;li&gt;Autorisation des routes publiques.&lt;/li&gt;
     *   &lt;li&gt;Formulaire de login configuré sur &lt;code&gt;/auth/login&lt;/code&gt;.&lt;/li&gt;
     *   &lt;li&gt;Gestion de la génération et de la suppression du cookie JWT.&lt;/li&gt;
     *   &lt;li&gt;Page d’accès refusé personnalisée.&lt;/li&gt;
     * &lt;/ul&gt;
     *
     * @param http objet {@link HttpSecurity} configuré par Spring
     * @return la {@link SecurityFilterChain} résultante
     * @throws Exception en cas d’erreur de configuration
     */
    @Bean
    public SecurityFilterChain securityFilterChain(HttpSecurity http) throws Exception {
<span class="fc" id="L91">        http</span>
<span class="fc" id="L92">          .csrf(csrf -&gt; csrf.csrfTokenRepository(CookieCsrfTokenRepository.withHttpOnlyFalse()))</span>
<span class="fc" id="L93">          .authorizeHttpRequests(auth -&gt; auth</span>
<span class="fc" id="L94">              .requestMatchers(</span>
                  &quot;/auth/register&quot;, &quot;/auth/login&quot;, &quot;/access-denied&quot;,
                  &quot;/logout&quot;, &quot;/css/**&quot;, &quot;/js/**&quot;, &quot;/images/**&quot;,
                  &quot;/actuator/**&quot;
<span class="fc" id="L98">              ).permitAll()</span>
<span class="fc" id="L99">              .anyRequest().authenticated()</span>
          )
<span class="fc" id="L101">          .formLogin(form -&gt; form</span>
<span class="fc" id="L102">              .loginPage(&quot;/auth/login&quot;)</span>
<span class="fc" id="L103">              .loginProcessingUrl(&quot;/auth/login&quot;)</span>
<span class="fc" id="L104">              .successHandler((req, res, authentication) -&gt; {</span>
<span class="nc" id="L105">                  String token = jwtIssuer.issue(</span>
<span class="nc" id="L106">                      authentication.getName(),</span>
<span class="nc" id="L107">                      authentication.getAuthorities().stream().toList()</span>
                  );

<span class="nc" id="L110">                  Cookie cookie = new Cookie(&quot;ACCESS_TOKEN&quot;, token);</span>
<span class="nc" id="L111">                  cookie.setHttpOnly(true);</span>
<span class="nc" id="L112">                  cookie.setPath(&quot;/&quot;);</span>
<span class="nc" id="L113">                  cookie.setMaxAge(3600);</span>
<span class="nc" id="L114">                  res.addCookie(cookie);</span>

<span class="nc" id="L116">                  res.sendRedirect(&quot;http://localhost:8080/patients&quot;);</span>
<span class="nc" id="L117">              })</span>
<span class="fc" id="L118">              .failureUrl(&quot;/auth/login?error&quot;)</span>
<span class="fc" id="L119">              .permitAll()</span>
          )
<span class="fc" id="L121">          .logout(logout -&gt; logout</span>
<span class="fc" id="L122">              .logoutUrl(&quot;/logout&quot;)</span>
<span class="fc" id="L123">              .addLogoutHandler((req, res, auth) -&gt; {</span>
<span class="nc" id="L124">                  Cookie cookie = new Cookie(&quot;ACCESS_TOKEN&quot;, &quot;&quot;);</span>
<span class="nc" id="L125">                  cookie.setHttpOnly(true);</span>
<span class="nc" id="L126">                  cookie.setPath(&quot;/&quot;);</span>
<span class="nc" id="L127">                  cookie.setMaxAge(0);</span>
<span class="nc" id="L128">                  res.addCookie(cookie);</span>
<span class="nc" id="L129">              })</span>
<span class="fc" id="L130">              .logoutSuccessUrl(&quot;/auth/login?logout&quot;)</span>
<span class="fc" id="L131">              .permitAll()</span>
          )
<span class="fc" id="L133">          .exceptionHandling(e -&gt; e.accessDeniedPage(&quot;/access-denied&quot;));</span>

<span class="fc" id="L135">        return http.build();</span>
    }

    /**
     * Fournit un encodeur de mots de passe utilisant BCrypt.
     *
     * @return une instance de {@link PasswordEncoder}
     */
    @Bean
    public PasswordEncoder passwordEncoder() {
<span class="fc" id="L145">        return new BCryptPasswordEncoder();</span>
    }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.11.202310140853</span></div></body></html>